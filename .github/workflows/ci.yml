name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      heavy: ${{ steps.filter.outputs.heavy }}
      qdrant: ${{ steps.filter.outputs.qdrant }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ github.token }}
          filters: |
            heavy:
              - "src/**"
              - "tests/integration/**"
              - "tests/fixtures/**"
              - "pyproject.toml"
              - "uv.lock"
              - ".github/workflows/ci.yml"
              - "examples/**"
            qdrant:
              - "src/orchid_commons/db/qdrant.py"
              - "src/orchid_commons/db/vector.py"
              - "src/orchid_commons/config/models.py"
              - "src/orchid_commons/runtime/manager.py"
              - "tests/integration/connectors/test_qdrant_integration.py"
              - "tests/integration/e2e/test_e2e_all_modules.py"
              - "pyproject.toml"
              - "uv.lock"
              - ".github/workflows/ci.yml"

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --extra dev --extra sqlite --frozen

      - name: Lint with ruff
        run: uv run ruff check .

      - name: Check formatting
        run: uv run ruff format --check .

      - name: Type check with mypy
        run: uv run mypy src

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --extra all --extra dev --frozen

      - name: Run unit tests with coverage (3.11)
        if: matrix.python-version == '3.11'
        run: >
          uv run pytest
          -m "not integration and not e2e"
          --maxfail=1
          --cov=src
          --cov-report=term-missing
          --cov-report=xml

      - name: Run unit tests (3.12/3.13)
        if: matrix.python-version != '3.11'
        run: uv run pytest -m "not integration and not e2e" --maxfail=1

  integration:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.heavy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --extra all --extra dev --frozen

      - name: Run connector/observability integration tests
        run: >
          uv run pytest
          tests/integration/connectors
          tests/integration/observability
          -m "integration and not e2e"
          --maxfail=1

  e2e:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.heavy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --extra all --extra dev --frozen

      - name: Run end-to-end suite
        run: >
          uv run pytest
          tests/integration/e2e/test_e2e_all_modules.py
          -m e2e
          --maxfail=1

  qdrant-compat:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.qdrant == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        qdrant-image: ["qdrant/qdrant:v1.15.0", "qdrant/qdrant:v1.16.2"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --extra all --extra dev --frozen

      - name: Run Qdrant compatibility integration tests
        env:
          ORCHID_QDRANT_IMAGE: ${{ matrix.qdrant-image }}
        run: >
          uv run pytest
          tests/integration/connectors/test_qdrant_integration.py
          tests/integration/e2e/test_e2e_all_modules.py
          -m integration
          -k qdrant
          --maxfail=1

  security:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --extra all --extra dev --frozen

      - name: Audit dependencies
        run: uv run pip-audit
        continue-on-error: true
